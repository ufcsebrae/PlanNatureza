<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Execução Orçamentária</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        .card { background-color: white; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -2px rgba(0,0,0,0.1); padding: 1.5rem; }
        .kpi-title { font-size: 0.875rem; color: #475569; font-weight: 500; }
        .kpi-value { font-size: 2.25rem; font-weight: 700; color: #1e293b; }
        .kpi-perc { font-size: 1.25rem; }
        .kpi-sub { font-size: 0.875rem; color: #64748b; }
        .chart-container { position: relative; height: 400px; width: 100%; }
        body { background-color: #f8fafc; }
    </style>
</head>
<body class="p-4 md:p-8">
    <main class="max-w-7xl mx-auto">
        <!-- Header -->
        <div class="card mb-8">
            <h1 class="text-3xl font-bold text-gray-800">Dashboard de Execução Orçamentária 2025</h1>
            <p id="unit-name" class="text-xl text-indigo-600 font-semibold mt-1">__UNIDADE_ALVO__</p>
        </div>

        <!-- ... (Seção de KPIs e outros gráficos permanece a mesma) ... -->
        
        <!-- Heatmap Section -->
        <div class="grid grid-cols-1 gap-8 mb-10">
            <div class="card">
                <h2 class="text-xl font-bold text-gray-800 mb-2">Mapa de Performance (Heatmap)</h2>
                <p class="text-sm text-gray-500 mb-4">Cruzamento da performance de execução (%) entre Projetos e Naturezas Orçamentárias.</p>
                
                <!-- ALTERAÇÃO PRINCIPAL AQUI -->

                <!-- 1. Heatmap para Desktop (visível apenas em telas médias e grandes) -->
                <div class="hidden md:block" style="overflow-x: auto; padding-bottom: 15px;">
                    <div id="heatmapProjetos" class="chart-container" style="min-width: 800px; height: 600px;">__HEATMAP_PLACEHOLDER__</div>
                </div>

                <!-- 2. Lista Acordeão para Celular (visível apenas em telas pequenas) -->
                <div id="heatmap-mobile-accordion" class="md:hidden space-y-2">
                    <!-- O JavaScript irá popular esta área -->
                </div>
                
            </div>
        </div>

    </main>

    <!-- Ilha de dados JSON -->
    <script id="data-island" type="application/json">__JSON_DATA_PLACEHOLDER__</script>

    <!-- Template para o item do acordeão (escondido) -->
    <template id="accordion-item-template">
        <div class="border border-gray-200 rounded-lg">
            <button class="accordion-header flex justify-between items-center w-full p-4 text-left">
                <span class="font-semibold text-gray-700 project-name"></span>
                <span class="text-gray-500 transform transition-transform duration-200">&#9662;</span>
            </button>
            <div class="accordion-content hidden p-4 border-t border-gray-200">
                <ul class="space-y-2 nature-list"></ul>
            </div>
        </div>
    </template>
    
    <!-- Template para o item da lista de naturezas (escondido) -->
    <template id="nature-list-item-template">
         <li class="flex justify-between items-center text-sm">
            <span class="text-gray-600 nature-name"></span>
            <span class="font-bold nature-value"></span>
        </li>
    </template>


    <!-- Script para renderizar os gráficos -->
    <script>
        // Lógica para renderizar os gráficos...
        // ... (seu script JS existente para os outros gráficos) ...

        // --- NOVO SCRIPT PARA O ACORDEÃO DO HEATMAP ---
        function createHeatmapAccordion(plotlyData) {
            if (!plotlyData || !plotlyData.z || !plotlyData.y || !plotlyData.x) return;

            const accordionContainer = document.getElementById('heatmap-mobile-accordion');
            const itemTemplate = document.getElementById('accordion-item-template');
            const natureTemplate = document.getElementById('nature-list-item-template');

            plotlyData.y.forEach((projectName, i) => {
                const itemNode = itemTemplate.content.cloneNode(true);
                const header = itemNode.querySelector('.accordion-header');
                const content = itemNode.querySelector('.accordion-content');
                const natureList = itemNode.querySelector('.nature-list');

                itemNode.querySelector('.project-name').textContent = projectName;

                plotlyData.x.forEach((natureName, j) => {
                    const value = plotlyData.z[i][j];
                    if (value !== null && value !== undefined) {
                        const natureNode = natureTemplate.content.cloneNode(true);
                        const valueEl = natureNode.querySelector('.nature-value');

                        natureNode.querySelector('.nature-name').textContent = natureName;
                        valueEl.textContent = `${value.toFixed(1)}%`;
                        
                        if (value < 50) { valueEl.style.color = '#ef4444'; } // Red
                        else if (value < 85) { valueEl.style.color = '#f59e0b'; } // Amber
                        else { valueEl.style.color = '#22c55e'; } // Green

                        natureList.appendChild(natureNode);
                    }
                });

                header.addEventListener('click', () => {
                    content.classList.toggle('hidden');
                    header.querySelector('span:last-child').classList.toggle('rotate-180');
                });
                
                accordionContainer.appendChild(itemNode);
            });
        }
        
        // Extrai os dados do Plotly e chama a função do acordeão
        try {
            const plotlyDiv = document.getElementById('heatmapProjetos');
            if (plotlyDiv && plotlyDiv.querySelector('.plotly-graph-div')) {
                const plotlyData = JSON.parse(plotlyDiv.querySelector('.plotly-graph-div').getAttribute('data-plotly-graph-2d-array'));
                createHeatmapAccordion(plotlyData.data[0]);
            }
        } catch (e) {
            console.error("Erro ao processar dados do heatmap para a visão mobile:", e);
        }

    </script>
</body>
</html>
